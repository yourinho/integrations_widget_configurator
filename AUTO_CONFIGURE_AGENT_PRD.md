# PRD: Auto-configure Agent — анализ лендинга и автоматическая настройка виджета

## Содержание

- [1. Продуктовое описание](#1-продуктовое-описание)
- [2. Цели и критерии успеха](#2-цели-и-критерии-успеха)
- [3. Входные данные](#3-входные-данные)
- [4. Выходные данные](#4-выходные-данные)
- [5. Архитектура (гибридный вариант)](#5-архитектура-гибридный-вариант)
- [6. Пользовательский сценарий](#6-пользовательский-сценарий)
- [7. UI в боковой панели](#7-ui-в-боковой-панели)
- [8. Технические требования](#8-технические-требования)
- [9. Риски и митигации](#9-риски-и-митигации)
- [10. Out of Scope](#10-out-of-scope)
- [11. Ссылки](#11-ссылки)

---

## 1. Продуктовое описание

### Суть

**Auto-configure Agent** — функция конфигуратора Albato Widget, которая по URL лендинга клиента автоматически извлекает дизайн-токены (цвета, шрифты, скругления, тени) и предлагает настройки виджета для гармоничной интеграции на странице.

Пользователь вводит ссылку → агент анализирует лендинг → в боковой панели появляются предложенные настройки → пользователь видит результат в превью, может принять целиком или скорректировать вручную.

### Проблема

Ручная настройка цветов, шрифтов и отступов виджета под лендинг требует знания дизайна страницы и времени. Клиент может ошибиться при выборе HEX-кодов или не заметить несоответствий.

### Решение

Автоматический анализ лендинга и генерация конфигурации по извлечённым токенам. Агент работает по гибридной схеме: детерминированный парсер + LLM для сложных случаев + валидация результата.

---

## 2. Цели и критерии успеха

### Цели

- Сократить время настройки виджета под лендинг до нескольких секунд
- Улучшить визуальную согласованность виджета с сайтом клиента
- Снизить порог входа: пользователь не должен уметь подбирать цвета вручную

### Критерии успеха

- В ≥70% случаев предложенная конфигурация визуально уместна на лендинге (оценка по тестам на реальных сайтах)
- Латентность анализа ≤10 сек в 95% запросов
- Пользователь всегда может отклонить или изменить любые предложенные значения
- Система не падает при недоступности URL, блокировке CORS, пустой странице

---

## 3. Входные данные

### Обязательные

| Вход | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| **URL лендинга** | `string` | Полная ссылка на страницу клиента | Формат URL; только `https://`; длина до 2048 символов; whitelist доменов (опционально) |

### Опциональные (расширения)

| Вход | Тип | Описание |
|------|-----|----------|
| Регион | `string` | Контекст (напр. ru, en) для LLM, если нужна локализация подсказок |
| Приоритет | `enum` | `conservative` / `balanced` / `aggressive` — насколько сильно отклоняться от дефолтов виджета |

### Пример

```
Вход:
{
  "url": "https://example.com/integrations"
}
```

---

## 4. Выходные данные

### Схема конфигурации

Агент возвращает частичную конфигурацию, совместимую с [WidgetConfig.getInitWidgetParams](lib/config.js). Рекомендуется заполнять только те поля, которые удалось надёжно извлечь.

#### Цвета (colors)

| Ключ | Описание | Источник на лендинге |
|------|----------|----------------------|
| `primary` | Акцентный цвет | Кнопки CTA, ссылки, активные состояния |
| `background` | Фон | `body`, `main`, основной контейнер |
| `surface` | Вторичный фон | Карточки, боковые панели |
| `text` | Основной текст | `body`, `p`, `h1`-`h6` |
| `textMuted` | Приглушённый текст | Подзаголовки, placeholder |
| `border` | Границы | `border-color` контейнеров |
| `textOnPrimary` | Текст на кнопках | Обычно белый или контрастный |
| `cardBackground` | Фон карточек | Карточки, блоки |
| `cardHoverShadow` | Тень при hover | `box-shadow` при наведении |
| `cardRadius` | Скругление карточек | `border-radius` кнопок/карточек |

#### Типографика

| Ключ | Описание | Источник |
|------|----------|----------|
| `font` | Шрифт | `font-family` body, заголовков |
| `cardTitleSize` | Размер заголовка карточки | Типографика карточек |
| `cardTitleWeight` | Вес заголовка | `font-weight` |

#### Layout (по желанию)

| Ключ | Описание | Источник |
|------|----------|----------|
| `cardRadius` | Скругление карточек (px) | `border-radius` |
| `detailCardRadius` | Скругление детальных карточек | Аналогично |
| `maxWidth` | Максимальная ширина блока | Контейнеры контента |

#### Маппинг font → SUPPORTED_FONTS

Извлечённый `font-family` нужно сопоставить с [SUPPORTED_FONTS](lib/config.js). Если точного совпадения нет — выбрать ближайший или оставить дефолт (`''` = Inter).

---

## 5. Архитектура (гибридный вариант)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Configurator (Frontend)                            │
│  ┌──────────────────┐                                                    │
│  │ URL input + [▶]  │ ──POST /api/analyze──►                              │
│  └──────────────────┘                                                    │
└─────────────────────────────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                     Backend / Serverless (API)                            │
│                                                                          │
│  1. Fetch URL (proxy, bypass CORS)                                       │
│  2. Parser (rule-based)                                                  │
│     • CSS variables (--primary, --color-accent, --background, etc.)      │
│     • meta theme-color                                                   │
│     • inline styles on buttons, cards, body                              │
│     • stylesheet hrefs → fetch & parse                                   │
│     • Dominant color from buttons/links (computed styles if headless)    │
│  3. If parser result insufficient → LLM fallback                         │
│     • Input: HTML snippet + extracted tokens                            │
│     • Prompt: map to widget config schema                                │
│     • Output: JSON partial config                                        │
│  4. Validator                                                             │
│     • Schema check, hex format, allowed font values                     │
│     • Sanitize, clamp numbers                                            │
│  5. Response: { suggested: {...}, source: "parser"|"llm", confidence }    │
└─────────────────────────────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        Configurator (Frontend)                            │
│  • Apply suggested config to form state                                  │
│  • Highlight changed fields (e.g. yellow)                                 │
│  • [Accept all] [Review] [Discard]                                        │
│  • User sees result in preview                                            │
└─────────────────────────────────────────────────────────────────────────┘
```

### Очередность обработки

1. **Parser first** — быстрый, детерминированный, дешёвый.
2. **LLM fallback** — если parser вернул мало данных или низкий confidence.
3. **Validator** — всегда, перед ответом клиенту.

---

## 6. Пользовательский сценарий

### Основной flow

1. Пользователь открывает конфигуратор.
2. В боковой панели находит секцию «Auto-configure from URL».
3. Вставляет URL лендинга (например, `https://client-site.com`).
4. Нажимает «Analyze» (или Enter).
5. Видит состояние «Analyzing…» (5–15 сек).
6. Агент возвращает suggested config.
7. Значения подставляются в форму; изменённые поля подсвечиваются.
8. Превью виджета обновляется в реальном времени.
9. Пользователь нажимает «Accept all» или вручную правит нужные поля.
10. При необходимости получает embed code через «Get embed code».

### Ошибки

- **URL недоступен** — сообщение «Could not load page. Check URL and try again».
- **Нет дизайн-токенов** — «No design tokens found. Try another page or configure manually.»
- **Таймаут** — «Analysis timed out. Try again.»

---

## 7. UI в боковой панели

### Макет секции

```
┌─────────────────────────────────────────┐
│ Auto-configure from URL                 │
├─────────────────────────────────────────┤
│ [https://client-landing.com         ] [▶]│
│                                         │
│ ○ Idle                                  │
│ ● Analyzing... (5s)                     │
│ ● Suggested config applied              │
│   [Accept all] [Discard]                │
│ ○ Error: Could not load page             │
└─────────────────────────────────────────┘
```

### Состояния

| Состояние | Описание |
|-----------|----------|
| Idle | Поле ввода пустое или ещё не нажимали Analyze |
| Loading | Отправлен запрос, показываем спиннер + «Analyzing…» |
| Success | Конфиг применён, подсвечены изменения, кнопки Accept / Discard |
| Error | Сообщение об ошибке, возможность повторить |

### Подсветка изменённых полей

- Фон изменённого поля: `rgba(255, 89, 44, 0.08)` или аналогичный акцент.
- Опционально: бейдж «Suggested» рядом с секцией Colors / Typography.

---

## 8. Технические требования

### API

- **Endpoint:** `POST /api/analyze` (или `POST /api/auto-configure`)
- **Request body:** `{ url: string }`
- **Response:**  
  `{ suggested: Partial<WidgetConfig>, source: "parser"|"llm", confidence?: number }`  
  или `{ error: string }`

### Безопасность

- Валидация URL: только `https`, не `javascript:`, не localhost (или разрешить по флагу).
- Ограничение размера ответа страницы (например, 2 MB).
- Таймаут fetch: 15 сек.
- Rate limit: например, 10 запросов/мин на пользователя.
- Защита от SSRF: запрет внутренних IP, проверка redirect.

### Инфраструктура

- Serverless (Vercel, Netlify, AWS Lambda) — для MVP.
- При необходимости headless: отдельный сервис на базе Puppeteer/Playwright.
- LLM: Claude API, OpenAI API или аналог.

---

## 9. Риски и митигации

| Риск | Митигация |
|------|-----------|
| CORS блокирует fetch | Использовать backend-прокси, никогда не фетчить с фронта напрямую |
| Лендинг грузится через JS | Headless (Puppeteer) для full render; или явно ограничить поддержку статичных страниц |
| LLM возвращает невалидный JSON | Строгая валидация схемы, retry с уточнённым промптом |
| Высокая стоимость LLM | Использовать LLM только при fallback; кэшировать по URL (TTL 24h) |
| Страница требует авторизации | Не поддерживаем в v1; сообщение «Page may require login» |
| Злоупотребление (скрапинг) | Rate limit, captcha при подозрительной активности |

---

## 10. Out of Scope

- Анализ страниц с авторизацией.
- Изменение `regions`, `partnerIds` — только стили и типографика.
- Сохранение/шаринг «магических» preset’ов через URL.
- Поддержка `http` (только `https`).
- A/B тесты разных стратегий агента в первой версии.

---

## 11. Ссылки

- [WYSIWYG Configurator PRD](./WYSIWYG_CONFIGURATOR_PRD.md)
- [lib/config.js](./lib/config.js) — схема конфигурации, DEFAULT_*
- [EMBEDDING_TUTORIAL](https://github.com/yourinho/integrations_widget/blob/main/EMBEDDING_TUTORIAL.md) — параметры initWidget
